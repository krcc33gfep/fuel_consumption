<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>燃費チェックビューワー</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body {
    background:#000;
    color:#fff;
    font-family:"M PLUS Rounded 1c", sans-serif;
    margin:0;
    font-size:17px;
  }

  header {
    background:#111;
    border-bottom:1px solid #222;
    padding:10px;
  }

  /* 並び替え＋追加ボタン */
#sortButtons {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;  /* ← そのままでOK */
  gap: 4px;
}

#sortButtons button {
  flex: 1;
  min-width: 58px;        /* ← 少しだけ小さく（60→58） */
  background: #222;
  color: #fff;
  border: 1px solid #555;
  border-radius: 6px;
  padding: 2px 6px;       /* ← 余白を軽めに */
  font-size: 15.5px;      /* ← 少しだけ文字サイズを下げる */
  line-height: 1;
  height: 30px;           /* ← 高さも微調整 */
  box-sizing: border-box;
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
}

#sortButtons button:hover {
  border-color: #0f0;
  color: #0f0;
}

  /* 一覧 */
  .container {
    padding:10px;
    box-sizing:border-box;
    width:800px;
    max-width:100%;
    margin:0 auto;
  }

  .row {
    border-bottom:1px solid #222;
    padding:6px 4px;
    line-height:1.4em;
  }

  .line1 {
    display:grid;
    grid-template-columns:repeat(4,auto);
    justify-content:space-between;
    align-items:center;
    font-size:0.95em;
    color:#eee;
  }

  .line1 div { text-align:right; }
  .line1 div:first-child { text-align:left; }
  .line1 div:last-child { color:#aaa; }

  .line2 {
    display:grid;
    grid-template-columns:repeat(4,auto);
    justify-content:space-between;
    align-items:center;
    font-size:1.3em;
    color:#eee;
  }

  .line2 div { text-align:right; }
  .line2 div:nth-child(2) { color:#FFB000; }
  .line2 .highlight { color:#0f0; }

  @media (max-width:600px){
    body { font-size:15px; }
    #sortButtons button { font-size:15px; }
  }
</style>
</head>

<body>

<header>
  <div id="sortButtons">
    <button data-key="日付">日付 ▼</button>
    <button data-key="数量">数量</button>
    <button data-key="金額">金額</button>
    <button data-key="単価">単価</button>
    <button data-key="燃費">燃費</button>
    <!-- プラスボタンを同じ見た目で追加 -->
    <button id="addButton" title="データを追加">＋</button>
  </div>
</header>

<div class="container" id="output">読み込み中...</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const csvUrl = "https://docs.google.com/spreadsheets/d/1YKMiMq2GpMAR3cqvqeiklqtGuQa8JJx4oO5YnpzxKso/gviz/tq?tqx=out:csv&sheet=燃費";
  let rows = [];
  let sortKey = "日付";
  let sortAsc = false;

  function formatDateDisplay(str) {
    const m = str.match(/(\\d{4})[\\/\\-](\\d{1,2})[\\/\\-](\\d{1,2})/);
    if (!m) return str;
    return `${m[1]}年${parseInt(m[2])}月${parseInt(m[3])}日`;
  }

  function parseSlashDate(str) {
    const m = str.match(/(\\d{4})[\\/\\-](\\d{1,2})[\\/\\-](\\d{1,2})/);
    if (!m) return new Date(0);
    return new Date(+m[1], +m[2]-1, +m[3]);
  }

  function loadCsv() {
    fetch(csvUrl)
      .then(r => r.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: results => {
            rows = results.data;
            sortAndRender();
          }
        });
      });
  }

  function sortAndRender() {
    rows.sort((a, b) => {
      let av = a[sortKey] || "", bv = b[sortKey] || "";
      if (sortKey === "日付") { av = parseSlashDate(av); bv = parseSlashDate(bv); }
      else { av = parseFloat(av) || 0; bv = parseFloat(bv) || 0; }
      return sortAsc ? av - bv : bv - av;
    });
    render(rows);
  }

  function render(data) {
    const out = document.getElementById("output");
    out.innerHTML = "";
    data.forEach(r => {
      const el = document.createElement("div");
      el.className = "row";
      el.innerHTML = `
        <div class="line1">
          <div>${formatDateDisplay(r["日付"] || "")}</div>
          <div>${r["ODO"] || ""}km</div>
          <div>${r["TRIP"] || ""}km</div>
          <div>${r["経過年月"] || ""}</div>
        </div>
        <div class="line2">
          <div>${r["数量"] || ""}L</div>
          <div>${r["金額"] || ""}円</div>
          <div>${r["単価"] || ""}円/L</div>
          <div class="highlight">${r["燃費"] || ""}km/L</div>
        </div>`;
      out.appendChild(el);
    });
  }

  // ソートボタン
  document.querySelectorAll("#sortButtons button[data-key]").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.dataset.key;
      if (sortKey === key) sortAsc = !sortAsc;
      else sortAsc = false;
      sortKey = key;
      document.querySelectorAll("#sortButtons button[data-key]").forEach(b => {
        b.textContent = b.dataset.key + (b.dataset.key === sortKey ? (sortAsc ? " ▲" : " ▼") : "");
      });
      sortAndRender();
    });
  });

  // プラスボタン（追加ページへ）
  document.getElementById("addButton").addEventListener("click", () => {
    window.location.href = "input.html";
  });

  loadCsv();
});
</script>

</body>
</html>
